<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Capture Face Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: Arial, sans-serif; display: flex; flex-direction: column;
            align-items: center; background-color: #f0f2f5; margin: 0; padding: 20px;
        }
        .container {
            position: relative; width: 640px; height: 480px;
            margin-bottom: 20px; background: #000;
        }
        #webcam, #output_canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #webcam { transform: scaleX(-1); }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; }
        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            border: none; border-radius: 5px; color: white; transition: background-color 0.3s;
        }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #startBtn { background-color: #28a745; }
        #captureBtn { background-color: #007bff; }
        #uploadBtn { background-color: #ffc107; color: #212529; }
        .status { margin-top: 10px; font-size: 16px; font-weight: bold; min-height: 20px; }
        .photo-gallery {
            display: flex; flex-wrap: wrap; gap: 10px; border-top: 2px solid #ccc;
            padding-top: 20px; width: 100%; max-width: 800px;
        }
        .photo-gallery img {
            width: 150px; height: 112px; border: 2px solid #ddd;
            border-radius: 5px; object-fit: cover;
        }
    </style>
</head>
<body>
    <h1>Multi-Capture with Face Detection</h1>
    <div class="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>
    <div class="controls">
        <button id="startBtn" title="Start Camera">üì∑ Start Camera</button>
        <button id="captureBtn" title="Capture Photo" disabled>Capture</button>
        <button id="uploadBtn" title="Upload Photos" disabled>‚¨ÜÔ∏è Upload</button>
    </div>
    <p id="status" class="status"></p>
    <h2>Captured Photos</h2>
    <div id="photoGallery" class="photo-gallery"></div>

    <script>
        // === 1. GET HTML ELEMENTS ===
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const photoGallery = document.getElementById('photoGallery');
        const statusEl = document.getElementById('status');
        // This URL correctly points to your local Flask server when it runs on port 3000
        const SERVER_URL = 'http://localhost:3000/upload';

        // === 2. MEDIAPIPE SETUP (Same as before) ===
        const faceDetection = new FaceDetection({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}` });
        faceDetection.setOptions({ model: 'short', minDetectionConfidence: 0.5 });
        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.detections) {
                for (const detection of results.detections) {
                    drawRectangle(canvasCtx, detection.boundingBox, { color: 'red', lineWidth: 4, fillColor: '#00000000' });
                }
            }
        }
        faceDetection.onResults(onResults);

        // === 3. CAMERA LOGIC (Same as before) ===
        let camera = null;
        function startCamera() {
            camera = new Camera(videoElement, {
                onFrame: async () => { await faceDetection.send({ image: videoElement }); },
                width: 640, height: 480
            });
            camera.start();
            startBtn.textContent = 'Camera On';
            startBtn.disabled = true;
            captureBtn.disabled = false;
        }

        // === 4. CAPTURE PHOTO LOGIC ===
        function capturePhoto() {
            const imageDataUrl = canvasElement.toDataURL('image/png');
            const img = document.createElement('img');
            img.src = imageDataUrl;
            img.alt = "Captured Photo";
            photoGallery.appendChild(img);
            uploadBtn.disabled = false; // Enable upload button after first capture
        }

        // === 5. UPLOAD PHOTOS LOGIC ===
        async function uploadPhotos() {
            const images = document.querySelectorAll('#photoGallery img');
            if (images.length === 0) {
                statusEl.textContent = 'No photos to upload.';
                return;
            }

            statusEl.textContent = 'Uploading...';
            uploadBtn.disabled = true;

            // Collect all image data (base64 strings) from the <img> tags
            const imageData = Array.from(images).map(img => img.src);

            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: imageData })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const result = await response.json();
                statusEl.textContent = `‚úÖ ${result.message}`;
                // Optionally clear the gallery after successful upload
                // photoGallery.innerHTML = ''; 

            } catch (error) {
                console.error('Upload failed:', error);
                statusEl.textContent = `‚ùå Upload failed. See console for details.`;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // === 6. EVENT LISTENERS ===
        startBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', capturePhoto);
        uploadBtn.addEventListener('click', uploadPhotos);
    </script>
</body>
</html>
